"use strict";
function error() {
    throw new Error("internal error");
}
// TODO: support non ascii
function isSpace(char) {
    return /^\s$/.test(char);
}
function isIdentStart(char) {
    return /^[a-zA-Z_]$/.test(char);
}
function isIdent(char) {
    return /^[0-9a-zA-Z_]$/.test(char);
}
function isReservedSymbol(char) {
    return ['"', "'", '(', ')', '{', '}', '[', ']', '#'].includes(char);
}
function isSymbol(char) {
    if (isReservedSymbol(char) || (char == '_')) {
        return false;
    }
    ;
    return /^[\u0021-\u002F\u003A-\u0040\u005B-\u0060\u007B-\u007E]$/.test(char);
}
function isNumberStart(char) {
    return /^[0-9]$/.test(char);
}
function isNumber(char) {
    return /^[0-9_]$/.test(char);
}
class Lexer {
    constructor(byChar) {
        this.lastChar = null;
        this.lastToken = null;
        this.finished = false;
        this.chars = byChar[Symbol.iterator]();
    }
    nextChar() {
        if (this.lastChar && this.lastChar.use) {
            this.lastChar.use = false;
            return this.lastChar.char;
        }
        ;
        let { done, value: char } = this.chars.next();
        if (done) {
            return null;
        }
        ;
        this.lastChar = { char, use: false };
        return char;
    }
    ;
    unreadChar() {
        if (!this.lastChar || this.lastChar.use) {
            error();
        }
        ;
        this.lastChar.use = true;
    }
    ;
    takeWhile(predicate) {
        let str = "";
        while (true) {
            let char = this.nextChar();
            if (!char) {
                return str;
            }
            if (!predicate(char)) {
                this.unreadChar();
                return str;
            }
            ;
            str += char;
        }
        ;
    }
    ;
    nextToken() {
        if (this.lastToken && this.lastToken.use) {
            this.lastToken.use = false;
            return this.lastToken.token;
        }
        ;
        let char = this.nextChar();
        if (!char) {
            if (!this.finished) {
                this.finished = true;
                return { kind: "eol" };
            }
            ;
            return null;
        }
        ;
        if (isSpace(char)) {
            if (char == '\n') {
                return { kind: "eol" };
            }
            ;
            while (true) {
                char = this.nextChar();
                if (!char) {
                    return { kind: "eol" };
                }
                ;
                if (!isSpace(char)) {
                    break;
                }
                ;
                if (char == '\n') {
                    return { kind: "eol" };
                }
                ;
            }
            ;
        }
        ;
        if (isReservedSymbol(char)) {
            switch (char) {
                case '"':
                    let str = "";
                    while (true) {
                        let char = this.nextChar();
                        if (!char) {
                            throw new Error('string not closed with "');
                        }
                        ;
                        if (char == '"') {
                            return { kind: "string", value: str };
                        }
                        ;
                        if (char != '\r') {
                            str += char;
                        }
                        ;
                    }
                    ;
                case "'":
                    let char = this.nextChar();
                    if (!char || !isIdentStart(char)) {
                        throw new Error("bare '");
                    }
                    ;
                    this.unreadChar();
                    return { kind: "atom", value: this.takeWhile(isIdent) };
                case '(':
                    return { kind: "(" };
                case ')':
                    return { kind: ")" };
                case '{':
                    return { kind: "{" };
                case '}':
                    return { kind: "}" };
                case '[':
                    return { kind: "[" };
                case ']':
                    return { kind: "]" };
                case '#':
                    while (true) {
                        let char = this.nextChar();
                        if (!char || char == '\n') {
                            return { kind: "eol" };
                        }
                        ;
                    }
                    ;
                default:
                    error();
            }
            ;
        }
        else if (isIdentStart(char)) {
            this.unreadChar();
            return { kind: "ref", value: this.takeWhile(isIdent) };
        }
        else if (isNumberStart(char)) {
            this.unreadChar();
            let num = this.takeWhile(isNumber).replace("_", "");
            if ((num.length > 1) && num[0] == '0') {
                throw new Error(`zero padded number ${num}`);
            }
            ;
            return { kind: "number", value: BigInt(num) };
        }
        else if (isSymbol(char)) {
            this.unreadChar();
            return { kind: "symbol", value: this.takeWhile(isSymbol) };
        }
        else {
            // TODO: quote char when necessary
            throw new Error(`unknown character ${char}`);
        }
        ;
    }
    ;
    unreadToken() {
        if (!this.lastToken || this.lastToken.use) {
            error();
        }
        ;
        this.lastToken.use = true;
    }
    ;
    [Symbol.iterator]() {
        return new TokenIterator(this);
    }
    ;
}
;
class TokenIterator {
    constructor(lexer) {
        this.lexer = lexer;
    }
    ;
    next() {
        let token = this.lexer.nextToken();
        if (!token) {
            // the type of Iterator requires that we always return a valid Token
            // so we return eol here
            return { done: true, value: { kind: "eol" } };
        }
        ;
        return { done: false, value: token };
    }
    ;
}
;
function run() {
    let code = document.getElementById("code").value;
    let lexer = new Lexer(code);
    for (let ch of lexer) {
        console.log(ch);
    }
    ;
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyYXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjcmF0Y2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLFNBQVMsS0FBSztJQUNWLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUN0QyxDQUFDO0FBNEVELDBCQUEwQjtBQUUxQixTQUFTLE9BQU8sQ0FBQyxJQUFZO0lBQzVCLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsSUFBWTtJQUNqQyxPQUFPLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDakMsQ0FBQztBQUVELFNBQVMsT0FBTyxDQUFDLElBQVk7SUFDNUIsT0FBTyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsSUFBWTtJQUNyQyxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDckUsQ0FBQztBQUVELFNBQVMsUUFBUSxDQUFDLElBQVk7SUFDN0IsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsRUFBRTtRQUM1QyxPQUFPLEtBQUssQ0FBQztLQUNiO0lBQUEsQ0FBQztJQUNGLE9BQU8sMERBQTBELENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzlFLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxJQUFZO0lBQ2xDLE9BQU8sU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsSUFBWTtJQUM3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QUFBQSxDQUFDO0FBRUYsTUFBTSxhQUFhO0lBR2xCLFlBQVksS0FBWTtRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBQUEsQ0FBQztJQUVGLElBQUk7UUFDSCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ25DLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDWCxvRUFBb0U7WUFDcEUsd0JBQXdCO1lBQ3hCLE9BQU8sRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFDLElBQUksRUFBRSxLQUFLLEVBQUMsRUFBQyxDQUFDO1NBQzFDO1FBQUEsQ0FBQztRQUNGLE9BQU8sRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUMsQ0FBQztJQUNwQyxDQUFDO0lBQUEsQ0FBQztDQUNGO0FBQUEsQ0FBQztBQUVGLFNBQVMsR0FBRztJQUNYLElBQUksSUFBSSxHQUFJLFFBQVEsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFzQixDQUFDLEtBQUssQ0FBQztJQUN2RSxJQUFJLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QixLQUFLLElBQUksRUFBRSxJQUFJLEtBQUssRUFBRTtRQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2hCO0lBQUEsQ0FBQztBQUNILENBQUM7QUFBQSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZnVuY3Rpb24gZXJyb3IoKTogbmV2ZXIge1xuICAgIHRocm93IG5ldyBFcnJvcihcImludGVybmFsIGVycm9yXCIpO1xufVxuXG50eXBlIFJlZiA9IHtcblx0a2luZDogXCJyZWZcIjtcblx0dmFsdWU6IHN0cmluZztcbn07XG5cbnR5cGUgUVN5bWJvbCA9IHtcblx0a2luZDogXCJzeW1ib2xcIjtcblx0dmFsdWU6IHN0cmluZztcbn07XG5cbnR5cGUgUUF0b20gPSB7XG5cdGtpbmQ6IFwiYXRvbVwiO1xuXHR2YWx1ZTogc3RyaW5nO1xufTtcblxudHlwZSBRTnVtYmVyID0ge1xuXHRraW5kOiBcIm51bWJlclwiO1xuXHR2YWx1ZTogYmlnaW50O1xufTtcblxudHlwZSBRU3RyaW5nID0ge1xuXHRraW5kOiBcInN0cmluZ1wiO1xuXHR2YWx1ZTogc3RyaW5nO1xufTtcblxudHlwZSBPcGVuQnJhY2tldCA9IHtcblx0a2luZDogXCIoXCI7XG59O1xuXG50eXBlIENsb3NlZEJyYWNrZXQgPSB7XG5cdGtpbmQ6IFwiKVwiO1xufTtcblxudHlwZSBPcGVuQ3VybHkgPSB7XG5cdGtpbmQ6IFwie1wiO1xufTtcblxudHlwZSBDbG9zZWRDdXJseSA9IHtcblx0a2luZDogXCJ9XCI7XG59O1xuXG50eXBlIE9wZW5TcXVhcmUgPSB7XG5cdGtpbmQ6IFwiW1wiO1xufTtcblxudHlwZSBDbG9zZWRTcXVhcmUgPSB7XG5cdGtpbmQ6IFwiXVwiO1xufTtcblxudHlwZSBFbmRPZkxpbmUgPSB7XG5cdGtpbmQ6IFwiZW9sXCI7XG59O1xuXG50eXBlIFRva2VuID1cblx0fCBSZWZcblx0fCBRU3ltYm9sXG5cdHwgUUF0b21cblx0fCBRTnVtYmVyXG5cdHwgUVN0cmluZ1xuXHR8IE9wZW5CcmFja2V0XG5cdHwgQ2xvc2VkQnJhY2tldFxuXHR8IE9wZW5DdXJseVxuXHR8IENsb3NlZEN1cmx5XG5cdHwgT3BlblNxdWFyZVxuXHR8IENsb3NlZFNxdWFyZVxuXHR8IEVuZE9mTGluZTtcblxudHlwZSBUb2tlbldpdGhQb3NpdGlvbiA9IHtcblx0cGF0aDogc3RyaW5nO1xuXHRsaW5lOiBudW1iZXI7XG5cdGNvbHVtbjogbnVtYmVyO1xuXHR0b2tlbjogVG9rZW47XG59O1xuXG4vLyBUT0RPOiBzdXBwb3J0IG5vbiBhc2NpaVxuXG5mdW5jdGlvbiBpc1NwYWNlKGNoYXI6IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRyZXR1cm4gL15cXHMkLy50ZXN0KGNoYXIpO1xufVxuXG5mdW5jdGlvbiBpc0lkZW50U3RhcnQoY2hhcjogc3RyaW5nKTogYm9vbGVhbiB7XG5cdHJldHVybiAvXlthLXpBLVpfXSQvLnRlc3QoY2hhcik7XG59XG5cbmZ1bmN0aW9uIGlzSWRlbnQoY2hhcjogc3RyaW5nKTogYm9vbGVhbiB7XG5cdHJldHVybiAvXlswLTlhLXpBLVpfXSQvLnRlc3QoY2hhcik7XG59XG5cbmZ1bmN0aW9uIGlzUmVzZXJ2ZWRTeW1ib2woY2hhcjogc3RyaW5nKTogYm9vbGVhbiB7XG5cdHJldHVybiBbJ1wiJywgXCInXCIsICcoJywgJyknLCAneycsICd9JywgJ1snLCAnXScsICcjJ10uaW5jbHVkZXMoY2hhcik7XG59XG5cbmZ1bmN0aW9uIGlzU3ltYm9sKGNoYXI6IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRpZiAoaXNSZXNlcnZlZFN5bWJvbChjaGFyKSB8fCAoY2hhciA9PSAnXycpKSB7XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9O1xuXHRyZXR1cm4gL15bXFx1MDAyMS1cXHUwMDJGXFx1MDAzQS1cXHUwMDQwXFx1MDA1Qi1cXHUwMDYwXFx1MDA3Qi1cXHUwMDdFXSQvLnRlc3QoY2hhcik7XG59XG5cbmZ1bmN0aW9uIGlzTnVtYmVyU3RhcnQoY2hhcjogc3RyaW5nKTogYm9vbGVhbiB7XG5cdHJldHVybiAvXlswLTldJC8udGVzdChjaGFyKTtcbn1cblxuZnVuY3Rpb24gaXNOdW1iZXIoY2hhcjogc3RyaW5nKTogYm9vbGVhbiB7XG5cdHJldHVybiAvXlswLTlfXSQvLnRlc3QoY2hhcik7XG59XG5cbmNsYXNzIExleGVyIGltcGxlbWVudHMgSXRlcmFibGU8VG9rZW4+IHtcblx0Y2hhcnM6IEl0ZXJhdG9yPHN0cmluZz47XG5cdGxhc3RDaGFyOiB7Y2hhcjogc3RyaW5nLCB1c2U6IGJvb2xlYW59IHwgbnVsbCA9IG51bGw7XG5cdGxhc3RUb2tlbjoge3Rva2VuOiBUb2tlbiwgdXNlOiBib29sZWFufSB8IG51bGwgPSBudWxsO1xuXHRmaW5pc2hlZCA9IGZhbHNlO1xuXG5cdGNvbnN0cnVjdG9yKGJ5Q2hhcjogSXRlcmFibGU8c3RyaW5nPikge1xuXHRcdHRoaXMuY2hhcnMgPSBieUNoYXJbU3ltYm9sLml0ZXJhdG9yXSgpO1xuXHR9XG5cblx0bmV4dENoYXIoKTogc3RyaW5nIHwgbnVsbCB7XG5cdFx0aWYgKHRoaXMubGFzdENoYXIgJiYgdGhpcy5sYXN0Q2hhci51c2UpIHtcblx0XHRcdHRoaXMubGFzdENoYXIudXNlID0gZmFsc2U7XG5cdFx0XHRyZXR1cm4gdGhpcy5sYXN0Q2hhci5jaGFyO1xuXHRcdH07XG5cdFx0bGV0IHtkb25lLCB2YWx1ZTogY2hhcn0gPSB0aGlzLmNoYXJzLm5leHQoKTtcblx0XHRpZiAoZG9uZSkge1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fTtcblx0XHR0aGlzLmxhc3RDaGFyID0ge2NoYXIsIHVzZTogZmFsc2V9O1xuXHRcdHJldHVybiBjaGFyO1xuXHR9O1xuXG5cdHVucmVhZENoYXIoKTogdm9pZCB7XG5cdFx0aWYgKCF0aGlzLmxhc3RDaGFyIHx8IHRoaXMubGFzdENoYXIudXNlKSB7XG5cdFx0XHRlcnJvcigpO1xuXHRcdH07XG5cdFx0dGhpcy5sYXN0Q2hhci51c2UgPSB0cnVlO1xuXHR9O1xuXG5cdHRha2VXaGlsZShwcmVkaWNhdGU6IChjaGFyOiBzdHJpbmcpID0+IGJvb2xlYW4pOiBzdHJpbmcge1xuXHRcdGxldCBzdHIgPSBcIlwiO1xuXHRcdHdoaWxlICh0cnVlKSB7XG5cdFx0XHRsZXQgY2hhciA9IHRoaXMubmV4dENoYXIoKTtcblx0XHRcdGlmICghY2hhcikge1xuXHRcdFx0XHRyZXR1cm4gc3RyO1xuXHRcdFx0fVxuXHRcdFx0aWYgKCFwcmVkaWNhdGUoY2hhcikpIHtcblx0XHRcdFx0dGhpcy51bnJlYWRDaGFyKCk7XG5cdFx0XHRcdHJldHVybiBzdHI7XG5cdFx0XHR9O1xuXHRcdFx0c3RyICs9IGNoYXI7XG5cdFx0fTtcblx0fTtcblxuXHRuZXh0VG9rZW4oKTogVG9rZW4gfCBudWxsIHtcblx0XHRpZiAodGhpcy5sYXN0VG9rZW4gJiYgdGhpcy5sYXN0VG9rZW4udXNlKSB7XG5cdFx0XHR0aGlzLmxhc3RUb2tlbi51c2UgPSBmYWxzZTtcblx0XHRcdHJldHVybiB0aGlzLmxhc3RUb2tlbi50b2tlbjtcblx0XHR9O1xuXG5cdFx0bGV0IGNoYXIgPSB0aGlzLm5leHRDaGFyKCk7XG5cdFx0aWYgKCFjaGFyKSB7XG5cdFx0XHRpZiAoIXRoaXMuZmluaXNoZWQpIHtcblx0XHRcdFx0dGhpcy5maW5pc2hlZCA9IHRydWU7XG5cdFx0XHRcdHJldHVybiB7a2luZDogXCJlb2xcIn07XG5cdFx0XHR9O1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fTtcblxuXHRcdGlmIChpc1NwYWNlKGNoYXIpKSB7XG5cdFx0XHRpZiAoY2hhciA9PSAnXFxuJykge1xuXHRcdFx0XHRyZXR1cm4ge2tpbmQ6IFwiZW9sXCJ9O1xuXHRcdFx0fTtcblx0XHRcdHdoaWxlICh0cnVlKSB7XG5cdFx0XHRcdGNoYXIgPSB0aGlzLm5leHRDaGFyKCk7XG5cdFx0XHRcdGlmICghY2hhcikge1xuXHRcdFx0XHRcdHJldHVybiB7a2luZDogXCJlb2xcIn07XG5cdFx0XHRcdH07XG5cdFx0XHRcdGlmICghaXNTcGFjZShjaGFyKSkge1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9O1xuXHRcdFx0XHRpZiAoY2hhciA9PSAnXFxuJykge1xuXHRcdFx0XHRcdHJldHVybiB7a2luZDogXCJlb2xcIn07XG5cdFx0XHRcdH07XG5cdFx0XHR9O1xuXHRcdH07XG5cblx0XHRpZiAoaXNSZXNlcnZlZFN5bWJvbChjaGFyKSkge1xuXHRcdFx0c3dpdGNoIChjaGFyKSB7XG5cdFx0XHRjYXNlICdcIic6XG5cdFx0XHRcdGxldCBzdHIgPSBcIlwiO1xuXHRcdFx0XHR3aGlsZSAodHJ1ZSkge1xuXHRcdFx0XHRcdGxldCBjaGFyID0gdGhpcy5uZXh0Q2hhcigpO1xuXHRcdFx0XHRcdGlmICghY2hhcikge1xuXHRcdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKCdzdHJpbmcgbm90IGNsb3NlZCB3aXRoIFwiJylcblx0XHRcdFx0XHR9O1xuXHRcdFx0XHRcdGlmIChjaGFyID09ICdcIicpIHtcblx0XHRcdFx0XHRcdHJldHVybiB7a2luZDogXCJzdHJpbmdcIiwgdmFsdWU6IHN0cn1cblx0XHRcdFx0XHR9O1xuXHRcdFx0XHRcdGlmIChjaGFyICE9ICdcXHInKSB7XG5cdFx0XHRcdFx0XHRzdHIgKz0gY2hhcjtcblx0XHRcdFx0XHR9O1xuXHRcdFx0XHR9O1xuXHRcdFx0Y2FzZSBcIidcIjpcblx0XHRcdFx0bGV0IGNoYXIgPSB0aGlzLm5leHRDaGFyKCk7XG5cdFx0XHRcdGlmICghY2hhciB8fCAhaXNJZGVudFN0YXJ0KGNoYXIpKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiYmFyZSAnXCIpXG5cdFx0XHRcdH07XG5cdFx0XHRcdHRoaXMudW5yZWFkQ2hhcigpO1xuXHRcdFx0XHRyZXR1cm4ge2tpbmQ6IFwiYXRvbVwiLCB2YWx1ZTogdGhpcy50YWtlV2hpbGUoaXNJZGVudCl9O1xuXHRcdFx0Y2FzZSAnKCc6XG5cdFx0XHRcdHJldHVybiB7a2luZDogXCIoXCJ9O1xuXHRcdFx0Y2FzZSAnKSc6XG5cdFx0XHRcdHJldHVybiB7a2luZDogXCIpXCJ9O1xuXHRcdFx0Y2FzZSAneyc6XG5cdFx0XHRcdHJldHVybiB7a2luZDogXCJ7XCJ9O1xuXHRcdFx0Y2FzZSAnfSc6XG5cdFx0XHRcdHJldHVybiB7a2luZDogXCJ9XCJ9O1xuXHRcdFx0Y2FzZSAnWyc6XG5cdFx0XHRcdHJldHVybiB7a2luZDogXCJbXCJ9O1xuXHRcdFx0Y2FzZSAnXSc6XG5cdFx0XHRcdHJldHVybiB7a2luZDogXCJdXCJ9O1xuXHRcdFx0Y2FzZSAnIyc6XG5cdFx0XHRcdHdoaWxlICh0cnVlKSB7XG5cdFx0XHRcdFx0bGV0IGNoYXIgPSB0aGlzLm5leHRDaGFyKCk7XG5cdFx0XHRcdFx0aWYgKCFjaGFyIHx8IGNoYXIgPT0gJ1xcbicpIHtcblx0XHRcdFx0XHRcdHJldHVybiB7a2luZDogXCJlb2xcIn07XG5cdFx0XHRcdFx0fTtcblx0XHRcdFx0fTtcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGVycm9yKCk7XG5cdFx0XHR9O1xuXHRcdH0gZWxzZSBpZiAoaXNJZGVudFN0YXJ0KGNoYXIpKSB7XG5cdFx0XHR0aGlzLnVucmVhZENoYXIoKTtcblx0XHRcdHJldHVybiB7a2luZDogXCJyZWZcIiwgdmFsdWU6IHRoaXMudGFrZVdoaWxlKGlzSWRlbnQpfTtcblx0XHR9IGVsc2UgaWYgKGlzTnVtYmVyU3RhcnQoY2hhcikpIHtcblx0XHRcdHRoaXMudW5yZWFkQ2hhcigpO1xuXHRcdFx0bGV0IG51bSA9IHRoaXMudGFrZVdoaWxlKGlzTnVtYmVyKS5yZXBsYWNlKFwiX1wiLCBcIlwiKTtcblx0XHRcdGlmICgobnVtLmxlbmd0aCA+IDEpICYmIG51bVswXSA9PSAnMCcpIHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKGB6ZXJvIHBhZGRlZCBudW1iZXIgJHtudW19YClcblx0XHRcdH07XG5cdFx0XHRyZXR1cm4ge2tpbmQ6IFwibnVtYmVyXCIsIHZhbHVlOiBCaWdJbnQobnVtKX1cblx0XHR9IGVsc2UgaWYgKGlzU3ltYm9sKGNoYXIpKSB7XG5cdFx0XHR0aGlzLnVucmVhZENoYXIoKTtcblx0XHRcdHJldHVybiB7a2luZDogXCJzeW1ib2xcIiwgdmFsdWU6IHRoaXMudGFrZVdoaWxlKGlzU3ltYm9sKX1cblx0XHR9IGVsc2Uge1xuXHRcdFx0Ly8gVE9ETzogcXVvdGUgY2hhciB3aGVuIG5lY2Vzc2FyeVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGNoYXJhY3RlciAke2NoYXJ9YCk7XG5cdFx0fTtcblx0fTtcblxuXHR1bnJlYWRUb2tlbigpOiB2b2lkIHtcblx0XHRpZiAoIXRoaXMubGFzdFRva2VuIHx8IHRoaXMubGFzdFRva2VuLnVzZSkge1xuXHRcdFx0ZXJyb3IoKTtcblx0XHR9O1xuXHRcdHRoaXMubGFzdFRva2VuLnVzZSA9IHRydWU7XG5cdH07XG5cblx0W1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmF0b3I8VG9rZW4+IHtcblx0XHRyZXR1cm4gbmV3IFRva2VuSXRlcmF0b3IodGhpcyk7XG5cdH07XG59O1xuXG5jbGFzcyBUb2tlbkl0ZXJhdG9yIGltcGxlbWVudHMgSXRlcmF0b3I8VG9rZW4+IHtcblx0bGV4ZXI6IExleGVyO1xuXG5cdGNvbnN0cnVjdG9yKGxleGVyOiBMZXhlcikge1xuXHRcdHRoaXMubGV4ZXIgPSBsZXhlcjtcblx0fTtcblxuXHRuZXh0KCk6IEl0ZXJhdG9yUmVzdWx0PFRva2VuPiB7XG5cdFx0bGV0IHRva2VuID0gdGhpcy5sZXhlci5uZXh0VG9rZW4oKTtcblx0XHRpZiAoIXRva2VuKSB7XG5cdFx0XHQvLyB0aGUgdHlwZSBvZiBJdGVyYXRvciByZXF1aXJlcyB0aGF0IHdlIGFsd2F5cyByZXR1cm4gYSB2YWxpZCBUb2tlblxuXHRcdFx0Ly8gc28gd2UgcmV0dXJuIGVvbCBoZXJlXG5cdFx0XHRyZXR1cm4ge2RvbmU6IHRydWUsIHZhbHVlOiB7a2luZDogXCJlb2xcIn19O1xuXHRcdH07XG5cdFx0cmV0dXJuIHtkb25lOiBmYWxzZSwgdmFsdWU6IHRva2VufTtcblx0fTtcbn07XG5cbmZ1bmN0aW9uIHJ1bigpIHtcblx0bGV0IGNvZGUgPSAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJjb2RlXCIpIGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlO1xuXHRsZXQgbGV4ZXIgPSBuZXcgTGV4ZXIoY29kZSk7XG5cdGZvciAobGV0IGNoIG9mIGxleGVyKSB7XG5cdFx0Y29uc29sZS5sb2coY2gpO1xuXHR9O1xufTtcbiJdfQ==